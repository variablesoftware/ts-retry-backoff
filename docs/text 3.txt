import { withRetry } from '@variablesoftware/retry';

const isKvThrottle = (err: any) =>
  err?.name === 'RateLimitExceededError' || err?.status === 429;

async function safeGet<T>(kv: KVNamespace, key: string): Promise<T | null> {
  return withRetry(
    () => kv.get<T>(key),
    { retryOn: isKvThrottle }
  );
}

async function safePut(kv: KVNamespace, key: string, value: string) {
  return withRetry(
    () => kv.put(key, value),
    { retryOn: isKvThrottle }
  );
}